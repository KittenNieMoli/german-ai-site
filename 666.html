<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>AI å¾·è¯­å­¦ä¹ æ–‡ç« ç”Ÿæˆå™¨ + é˜…è¯»ç†è§£ + æ•´ç¯‡æœ—è¯»</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 40px auto; line-height: 1.6; }
    textarea, select, input, button { width: 100%; margin-top: 10px; padding: 8px; font-size: 16px; }
    section { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 20px; }
    h2 { margin-top: 0; color: #333; }
    .loading { color: #999; font-style: italic; }
    .tts-controls { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>AI å¾·è¯­å­¦ä¹ æ–‡ç« ç”Ÿæˆå™¨</h1>

  <label>è¯·è¾“å…¥ Gemini 2.5 API Keyï¼š</label>
  <input type="password" id="apiKey" placeholder="AIza å¼€å¤´çš„ Key">

  <label>ä¸»é¢˜ï¼š</label>
  <input type="text" id="topic" placeholder="ä¾‹å¦‚ï¼šTiere, Umwelt, Reisen">

  <label>éš¾åº¦ç­‰çº§ï¼š</label>
  <select id="level">
    <option value="A1">A1</option>
    <option value="A2">A2</option>
    <option value="B1">B1</option>
    <option value="B2">B2</option>
    <option value="C1">C1</option>
  </select>

  <button onclick="generateArticle()">ç”Ÿæˆæ–‡ç« </button>

  <div id="result" class="loading"></div>

  <!-- TTS æ’­æ”¾å™¨ -->
  <audio id="ttsPlayer" hidden></audio>

  <script>
    async function generateArticle() {
      const apiKey = document.getElementById("apiKey").value.trim();
      const topic = document.getElementById("topic").value.trim();
      const level = document.getElementById("level").value;

      if (!apiKey || !topic) {
        alert("è¯·å…ˆè¾“å…¥ Gemini API Key å’Œä¸»é¢˜");
        return;
      }

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "<p class='loading'>â³ æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</p>";

      const userPrompt = `
Du bist ein DaF-Lehrer.
Bitte antworte GENAU in diesem Format:

===å¾·è¯­æ–‡ç« ===
Schreibe einen kurzen deutschen Artikel (ca. 150 WÃ¶rter) Ã¼ber das Thema "${topic}". Der Text soll fÃ¼r Sprachniveau ${level} geeignet sein.

===ç”Ÿè¯è¡¨===
Liste 10 wichtige WÃ¶rter aus dem Text mit einer kurzen chinesischen Ãœbersetzung.

===ä¸­æ–‡ç¿»è¯‘===
Gib eine vollstÃ¤ndige chinesische Ãœbersetzung des Artikels.

===é˜…è¯»ç†è§£===
Stelle 5 einfache VerstÃ¤ndnisfragen zum Artikel. Jede Frage soll 3 AntwortmÃ¶glichkeiten (A, B, C) haben und zeige die richtige Antwort.
`;

      try {
        const response = await fetch(
          "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-goog-api-key": apiKey
            },
            body: JSON.stringify({
              contents: [{ parts: [{ text: userPrompt }] }]
            })
          }
        );

        const data = await response.json();
        console.log("Gemini è¿”å›ï¼š", data);

        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (text) {
          // âœ… ç”¨æ­£åˆ™æå–å†…å®¹
          const articleMatch = text.match(/===å¾·è¯­æ–‡ç« ===([\s\S]*?)===ç”Ÿè¯è¡¨===/);
          const vocabMatch   = text.match(/===ç”Ÿè¯è¡¨===([\s\S]*?)===ä¸­æ–‡ç¿»è¯‘===/);
          const transMatch   = text.match(/===ä¸­æ–‡ç¿»è¯‘===([\s\S]*?)===é˜…è¯»ç†è§£===/);
          const quizMatch    = text.match(/===é˜…è¯»ç†è§£===([\s\S]*)/);

          const article = articleMatch?.[1]?.trim() || "âš ï¸ æ²¡æ‰¾åˆ°æ–‡ç« ";
          const vocab   = vocabMatch?.[1]?.trim() || "âš ï¸ æ²¡æ‰¾åˆ°ç”Ÿè¯è¡¨";
          const trans   = transMatch?.[1]?.trim() || "âš ï¸ æ²¡æ‰¾åˆ°ä¸­æ–‡ç¿»è¯‘";
          const quiz    = quizMatch?.[1]?.trim() || "âš ï¸ æ²¡æ‰¾åˆ°ç»ƒä¹ é¢˜";

          let html = "";
          html += `<section>
            <h2>ğŸ“– å¾·è¯­æ–‡ç« </h2>
            <p id="germanText">${article.replace(/\n/g, "<br>")}</p>
            <div class="tts-controls">
              <button onclick="startFullTTS()">ğŸ”Š æ•´ç¯‡æœ—è¯»</button>
              <button onclick="pauseTTS()">â¸ æš‚åœ</button>
              <button onclick="resumeTTS()">â–¶ ç»§ç»­</button>
              <span id="ttsStatus"></span>
            </div>
          </section>`;

          html += `<section><h2>ğŸ“š ç”Ÿè¯è¡¨</h2><p>${vocab.replace(/\n/g, "<br>")}</p></section>`;
          html += `<section><h2>ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘</h2><p>${trans.replace(/\n/g, "<br>")}</p></section>`;
          html += `<section><h2>ğŸ“ é˜…è¯»ç†è§£</h2><p>${quiz.replace(/\n/g, "<br>")}</p></section>`;

          resultDiv.innerHTML = html;
        } else {
          resultDiv.innerHTML = `<p>âŒ è¿”å›é”™è¯¯ï¼š${JSON.stringify(data)}</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<p>âŒ è¯·æ±‚å¤±è´¥ï¼š${error}</p>`;
      }
    }

    // ======== æ•´ç¯‡æœ—è¯»æ§åˆ¶ ========
    let ttsChunks = [];
    let ttsIndex = 0;
    let isPaused = false;

    function startFullTTS() {
      const textElem = document.getElementById("germanText");
      if (!textElem) return alert("âš ï¸ æ²¡æœ‰å¾·è¯­æ–‡ç« å¯æœ—è¯»");

      const rawText = textElem.innerText.trim();
      if (!rawText) return alert("âš ï¸ æ–‡æœ¬ä¸ºç©º");

      // åˆ†æ®µ
      ttsChunks = [];
      for (let i = 0; i < rawText.length; i += 180) {
        ttsChunks.push(rawText.slice(i, i + 180));
      }
      ttsIndex = 0;
      isPaused = false;

      playNextChunk();
    }

    function playNextChunk() {
      if (ttsIndex >= ttsChunks.length) {
        document.getElementById("ttsStatus").innerText = "âœ… æœ—è¯»å®Œæˆ";
        return;
      }

      const segment = ttsChunks[ttsIndex];
      const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(segment)}&tl=de&client=tw-ob`;

      const audioElem = document.getElementById("ttsPlayer");
      audioElem.src = url;
      audioElem.hidden = false;
      audioElem.play();

      document.getElementById("ttsStatus").innerText =
        `â–¶ æ­£åœ¨æœ—è¯»ç¬¬ ${ttsIndex + 1}/${ttsChunks.length} æ®µ`;

      // æ’­æ”¾å®Œ â†’ ä¸‹ä¸€æ®µ
      audioElem.onended = () => {
        if (!isPaused) {
          ttsIndex++;
          playNextChunk();
        }
      };
    }

    function pauseTTS() {
      const audioElem = document.getElementById("ttsPlayer");
      audioElem.pause();
      isPaused = true;
      document.getElementById("ttsStatus").innerText = "â¸ å·²æš‚åœ";
    }

    function resumeTTS() {
      const audioElem = document.getElementById("ttsPlayer");
      if (isPaused) {
        isPaused = false;
        audioElem.play(); // å¦‚æœå½“å‰æ®µè¿˜æ²¡æ’­å®Œå°±ç»§ç»­æ’­
        document.getElementById("ttsStatus").innerText =
          `â–¶ ç»§ç»­æœ—è¯»ç¬¬ ${ttsIndex + 1}/${ttsChunks.length} æ®µ`;
        // å¦‚æœå½“å‰æ®µå·²ç»ç»“æŸï¼Œç»§ç»­ä¸‹ä¸€æ®µ
        if (audioElem.ended) {
          playNextChunk();
        }
      }
    }
  </script>
</body>
</html>